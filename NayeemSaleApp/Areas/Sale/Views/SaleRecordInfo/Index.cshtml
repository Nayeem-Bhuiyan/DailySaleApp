@model SaleRecordViewModel
@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section Style{
    <style>
        .select2 {
            width: 100% !important;
        }

        @@media (max-width: 768px) {
            .select2 {
                width: 70% !important;
            }
        }
    </style>

    <link rel="stylesheet" href="//code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">
}

<div class="row">
    <div class="col-xl-12">
        <div class="breadcrumb-holder">
            <h1 class="main-title float-left">Sale Info</h1>
            <ol class="breadcrumb float-right">
                <li class="breadcrumb-item"><a href="/Home/Index"><i class="fa fa-home fa-2x"></i></a></li>
                <li class="breadcrumb-item active"><a href="#">Sale</a></li>
            </ol>
            <div class="clearfix"></div>
        </div>
    </div>
</div>

<div class="row">

    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 col-xl-12">
        <div class="card mb-3">
            <div class="card-header">
                <h3><i class="fa fa-free-code-camp bigfonts"></i>Sale Bill Entry</h3>
            </div>

            <div class="card-body">

                <form autocomplete="off" id="frmData" asp-area="MasterData" asp-controller="CustomerInfo" asp-action="Index">
                    <div class="form-group row">
                        <label for="CustomerId" class="col-sm-2 col-form-label">Customer</label>
                        <div class="col-sm-4">
                            <select id="CustomerId" name="CustomerId">
                                <option value="value">Select</option>
                                @foreach (var customer in Model.customers)
                                {
                                    <option value="@customer.Id">@customer.customerName</option>
                                }
                            </select>
                        </div>
                        <label for="" class="col-sm-2 col-form-label">Bill Date</label>
                        <div class="col-sm-4">
                            <input type="text" name="billDate" id="billDate" value="" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <label>Product Code</label>
                            <div>
                                <input type="text" id="productCode" name="productCode" placeholder="Enter Product Code" required>
                                <input type="hidden" id="ProductId" name="ProductId" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="rate">Rate</label>
                            <div>
                                <input type="text" id="rate" name="rate" class="numeric" placeholder="Enter rate" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="quantity">Quantity</label>
                            <div>
                                <input type="text" id="quantity" name="quantity" class="numeric" placeholder="Enter Quantity" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label></label>
                            <div>
                                <button type="button" class="bg-primary text-white" id="btnAdd">Add</button>
                            </div>
                        </div>
                    </div>


                    <br />
                    <div class="row">
                        <div class="col-md-7">
                            <div class="row">
                                <div class="col-md-12">
                                    <table class="table table-bordered table-striped table-responsive-sm" id="tblAddProducts">
                                        <thead>
                                            <tr>
                                                <th>Code</th>
                                                <th>Rate</th>
                                                <th>Quantity</th>
                                                <th>Subtotal</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>

                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="3" class="text-right">Total</td>
                                                <td colspan="2"></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <div class="col-md-12">
                                    <br />
                                    <div class="row">
                                        <div class="col-md-6 col-sm-12">
                                            <label for="ProductId">Receive Amount</label>
                                            <div>
                                                <input type="text" id="receiveTotal" name="receiveTotal" placeholder="Enter receive Amount" required autocomplete="off">
                                            </div>
                                        </div>
                                        <div class="col-md-6 col-sm-12">
                                            <label for="ProductId">Change Amount</label>
                                            <div>
                                                <input type="text" id="changeAmount" name="changeAmount" placeholder="Change Amount" required readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-6 col-sm-12">
                                            <label for="payType">Payment Mode</label>
                                            <div>
                                                <select id="payType" name="payType" required autocomplete="off">
                                                    <option value="value">Select</option>
                                                    <option value="1">Cash</option>
                                                    <option value="2">Check</option>
                                                    <option value="3">Mobile Banking</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6 col-sm-12">
                                            <label>Remarks</label>
                                            <div>
                                                <input type="text" id="remarks" name="remarks" placeholder="Remarks" required autocomplete="off">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fa fa-table bg-success"></i>Payment Details</h5>
                                </div>
                                <div class="card-body" style="height: 100%;">
                                    <div class="form-group row">
                                        <label for="grossAmount" class="col-sm-5">Gross Amount</label>
                                        <div class="col-sm-7">
                                            <input type="text" name="grossAmount" id="grossAmount" value="" />
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label for="discountAmount" class="col-sm-5">Discount Amount</label>
                                        <div class="col-sm-7">
                                            <input type="text" name="discountAmount" id="discountAmount" value="" />
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label for="netAmount" class="col-sm-5">Net Amount</label>
                                        <div class="col-sm-7">
                                            <input type="text" name="netAmount" id="netAmount" value="" class="bg-success text-white" readonly />
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label for="vatAmount" class="col-sm-5">Vat Amount</label>
                                        <div class="col-sm-7">
                                            <input type="text" name="vatAmount" id="vatAmount" value="" />
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label class="col-sm-5">Grand Total</label>
                                        <div class="col-sm-7">
                                            <label id="grandTotal"></label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="row">
                        <div class="col-md-12 justify-content-end">
                            <div class="card">
                                <button type="submit" class="btn btn-success">Save Sale Bill</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div><!-- end card-->
        </div>
    </div>
</div>

<div class="row">

    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 col-xl-12">
        <div class="card mb-3">
            <div class="card-header">
                <h3><i class="fa fa-table"></i>Customer Information</h3>
            </div>

            <div class="card-body">
                <div class="table-responsive">
                    <table id="tblData" class="table table-bordered table-hover display">
                        <thead class="bg-success text-white">
                            <tr>
                                <th>ID</th>
                                <th>Customer</th>
                                <th>Contact</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.customers != null)
                            {
                                @foreach (var item in Model.customers)
                                {
                                    <tr>
                                        <td>@item?.Id</td>
                                        <td>@item?.customerName</td>
                                        <td>@item?.contactNumber</td>
                                        <td>
                                            <a class="btn btn-warning" onclick="Edit(@item.Id,'@item.customerName','@item.contactNumber')">Edit</a>
                                            <a class="btn btn-danger" onclick="Delete(@item.Id)">Delete</a>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr></tr>
                            }


                        </tbody>
                    </table>
                </div>

            </div>
        </div><!-- end card-->
    </div>
</div>


@section Scripts{
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>
    <script>
        $(document).ready(function () {
            CleanData();
            $("#tblData").DataTable({
                order: [[0, "desc"]]
            });

            $('#CustomerId').select2();
            var d = new Date();
            var strDate = d.getFullYear() + "/" + (d.getMonth() + 1) + "/" + d.getDate();
            $('#billDate').val(strDate);
            $('#billDate').flatpickr({ dateFormat: "Y/m/d", minDate: "@DateTime.Now.ToString("MM/dd/yyyy")", maxDate: strDate });

            Common.Ajax('GET', '/MasterData/ProductInfo/AllProduct', [], 'json', ajaxGetAllProduct);


            $(".numeric").keydown(function (e) {
                //Allow: backspace, delete, tab, escape, enter, ctrl+A and .
                if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 110, 190]) !== -1 ||
                    (e.keyCode === 65 && (e.ctrlKey === true || e.metaKey === true)) ||
                    (e.keyCode >= 35 && e.keyCode <= 40)) {
                    return;
                }
                if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                    e.preventDefault();
                }
            });
        })

        function Clear() {
            $("#productCode").val('');
            $("#ProductId").val('');
            $("#rate").val('');
            $("#quantity").val('');
        }

        $("#tblAddProducts tbody").on('click', '.remove', function () {
            $(this).closest('tr').remove();
            findTotal();
        })

        let findTotal=()=> {
            let totalBill = 0;
            $("#tblAddProducts tbody tr").each(function () {
                totalBill+=$(this).find("td").eq(3).text();
            });

            $("#tblAddProducts tfoot tr").find("td").eq(1).text(parseInt(totalBill))
        }

        let validationAddData = () => {

            var response = true;
            if ($("#productCode").val() === "undefined" || $("#productCode").val() === "") {
                alert("ProductCode required");
                response = false;
                return response;
            }
          
            if ($("#rate").val() === "undefined" || $("#rate").val() === "") {
                alert("Rate field required");
                response = false;
                return response;
            }
            if ($("#quantity").val() === "undefined" || $("#quantity").val() === "") {
                alert("Quantity field required");
                response = false;
                return response;
            }
            return response;
        }

        $("#btnAdd").click(function () {
            let response = validationAddData();
            let subTotal = 0;
            subTotal = $("#rate").val() * $("#quantity").val();
            if (response===true) {
                $('#tblAddProducts tbody').prepend('<tr>' +
                    '<td>' + $("#productCode").val() + '<span class="d-none">' + $("#ProductId").val() + '</span ></td>' +
                    '<td>' + $("#rate").val() + '</td>' +
                    '<td>' + $("#quantity").val() + '</td>' +
                    '<td>' + subTotal + '</td>' +
                    '<td><a class="btn btn-sm btn-danger remove">Delete</a></td>' +
                    '</tr>');
                findTotal();
                Clear();
            }
        });





            let ajaxGetAllProduct = (response) => {

                console.log(response);

                var allProduct = [];
                $.each(response, function (id, option) {
                    var obj = new Object();
                    obj.key = option.ProductId;
                    obj.value = option.productCode + ' (' +option.productName+' )';
                    allProduct[allProduct.length] = obj;
                });
                $('#productCode').autocomplete({
                    source: allProduct,
                    sortable: true,
                    select: function (event, ui) {
                        $("#ProductId").val(ui.item.key);
                        $("#productCode").val(ui.item.value);
                    }
                });

           
            }

        function CleanData() {
            $("#CustomerId").val(0);
            $("#customerName").val("");
            $("#contactNumber").val("");
        }

        function Edit(Id, customerName, contactNumber) {
            CleanData();
            $("#CustomerId").val(Id);
            $("#customerName").val(customerName);
            $("#contactNumber").val(contactNumber);
        }


        $("#contactNumber").keyup(function () {
            CheckDuplicate();
        });

        function CheckDuplicate() {

            var customer = $("#contactNumber").val().toLowerCase();
            $('#tblData tbody tr').each(function () {
                var customerInTable = $(this).find("td").eq(1).text().toLowerCase();
                if ($.trim(customer) == $.trim(customerInTable)) {
                    $(this).find("td").eq(1).addClass("bg-warning");
                    swal.fire('warning', 'Sorry!! duplicate valu has found', 'warning');
                    $("#contactNumber").val("");
                }
                else {
                    $(this).find("td").eq(1).removeClass("bg-warning");
                }
            });

        }


        $('#btnSave').click(function () {

            $('#frmData').on('submit', function (event) {

                event.preventDefault();
                CheckDuplicate();
                var frmdata = {
                    __RequestVerificationToken: $("[name='__RequestVerificationToken']").val(),
                    CustomerId: $("#CustomerId").val(),
                    customerName: $("#customerName").val(),
                    contactNumber: $("#contactNumber").val(),
                }

                console.log(frmdata);
                Swal.fire({
                    title: 'Are you sure?',
                    text: "You want to save this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, save it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: "/MasterData/CustomerInfo/Index",
                            type: "POST",
                            data: frmdata,
                            beforeSend: function () {
                                $('#btnSave').attr('disabled', 'disabled');
                                $('#btnSave').val('Submitting...');

                            },
                        }).done(function (data) {

                            $("#btnSave").removeAttr('disabled');
                            swal.fire('success', 'Saved Successfully!', 'success').then(function () {
                                CleanData();
                                location.reload();
                            });

                        }).fail(function () {
                            CleanData();
                            $("#btnSave").removeAttr('disabled');
                            swal.fire('warning', 'Failed!', 'warning');
                        })
                    }

                });
            })
        })

        function Delete(Id) {

            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to retrieve this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: "/MasterData/CustomerInfo/Delete/" + Id,
                        data: { Id: Id },
                        type: 'POST'
                    })
                        .done(function () {
                            Swal.fire({
                                icon: 'success',
                                title: 'Deleted Successfully!!',
                                showConfirmButton: false,
                                timer: 1000
                            }).then(function () {
                                window.location.reload();
                            })
                        })
                        .fail(function () {
                            swal.fire('Cancelled', 'It will not be deleted. Please try again later !!!', 'error');
                        });
                }
            });
        }
    </script>
}



